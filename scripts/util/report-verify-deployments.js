const hre = require("hardhat");

/**
 * Utilities for reporting deployments and verifying with
 * Etherscan-based block explorers.
 *
 * Reused between deployment script and unit tests for consistency.
 */
async function verifyOnBlockExplorer(contract) {
  console.log(`\nüìã Verifying ${contract.name}`);

  console.log("contract object in verify function ", contract);
  try {
    if (contract.name == "BosonVoucher Logic") contract.name == "BosonVoucher";
    if (contract.name == "BosonPriceDiscoveryClient") contract.name == "BosonPriceDiscovery";
    if (contract.name == "ProtocolInitializationHandlerFacet" || contract.name == "ConfigHandlerFacet") {
      // InitializationFacet uses `address(this)` in one of the immutable variables.
      // Consequently, the deployed bytecode is different from the one generated by Hardhat and pre-verification check fails.
      // To fix this, we need to update the deployed bytecode in the build info with the actual deployed bytecode.
      // Not sure why ConfigHandlerFacet has a similar verification issue, but this fixes it too.
      const { sourceName, contractName } = await hre.artifacts.readArtifact(contract.name);
      const facetDeployedBytecode = await hre.ethers.provider.getCode(contract.address);

      const facetBuildInfo = await hre.artifacts.getBuildInfo(`${sourceName}:${contractName}`);
      if (facetBuildInfo) {
        const contractOutput = facetBuildInfo.output.contracts[sourceName][contractName];
        contractOutput.evm.deployedBytecode.object = facetDeployedBytecode.slice(2);

        await hre.artifacts.saveBuildInfo(
          facetBuildInfo.solcVersion,
          facetBuildInfo.solcLongVersion,
          facetBuildInfo.input,
          facetBuildInfo?.output
        );
      }
    }

    if (contract.name == "BosonVoucher Beacon") {
      await hre.run("verify:verify", {
        contract: "contracts/protocol/clients/proxy/BosonClientBeacon.sol:BosonClientBeacon",
        address: contract.address,
        constructorArguments: contract.args,
      });
    } else {
      await hre.run("verify:verify", {
        address: contract.address,
        constructorArguments: contract.args,
      });
    }
  } catch (e) {
    console.log(`‚ùå Failed to verify ${contract.name} on block explorer. ${e.message}`);
  }
}

async function verifyOnTestEnv(contracts) {
  for (const contract of contracts) {
    console.log(`\nüìã Verifying on test env ${contract.name}`);
    try {
      const code = await hre.ethers.provider.getCode(contract.address);
      if (code === "0x0" || code === "0x") {
        console.log(`‚ùå Failed to verify ${contract.name} on test env.`);
      }
    } catch (e) {
      console.log(`‚ùå Failed to verify ${contract.name} on test env. ${e.message}`);
    }
  }
}

exports.verifyOnBlockExplorer = verifyOnBlockExplorer;
exports.verifyOnTestEnv = verifyOnTestEnv;
